<!DOCTYPE html>
<html lang="de">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Vorlesungsplan</title>
    <link rel="stylesheet" href="vorlesungsuebersicht.css" />
  </head>
  <body>
    <!--TODO replace placeholder header-->
    <header>
      <nav><h1>PLACEHOLDER header</h1></nav>
    </header>
    <main>
      <section id="class-plan-container" class="plan-container">
        <div id="loading-state" class="loading">Laden...</div>
        <div id="error-state" class="error hidden">Klasse nicht gefunden</div>
        <div id="plan-content" class="hidden">
          <div class="class-info">
            <div class="class-meta">
              <span id="class-id"></span>
              <span><b>&#183;</b></span>
              <span id="class-semester"></span>
            </div>
            <h2 id="class-title"></h2>
            <p id="class-description"></p>
          </div>
          <div class="accordion-container">
            <div class="accordion-section">
              <div
                class="accordion-header expanded"
                data-target="weeks-content"
              >
                <h3>Vorlesungsplan</h3>
                <span class="accordion-toggle"
                  ><svg
                    xmlns="http://www.w3.org/2000/svg"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke-width="2"
                    stroke="currentColor"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      d="m4.5 15.75 7.5-7.5 7.5 7.5"
                    /></svg
                ></span>
              </div>
              <div id="weeks-content" class="accordion-content expanded">
                <div id="weeks-container" class="weeks-timeline"></div>
              </div>
            </div>
            <div class="accordion-section">
              <div
                class="accordion-header collapsed"
                data-target="modules-content"
              >
                <h3>Module</h3>
                <!--TODO rotate animation on accordion toggle-->
                <span class="accordion-toggle">
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke-width="2"
                    stroke="currentColor"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      d="m19.5 8.25-7.5 7.5-7.5-7.5"
                    />
                  </svg>
                </span>
              </div>
              <div id="modules-content" class="accordion-content collapsed">
                <div id="modules-container" class="modules-grid"></div>
              </div>
            </div>
          </div>
        </div>
      </section>
    </main>
    <!--TODO replace placeholder footer-->
    <footer><h2>PLACEHOLDER footer</h2></footer>
    <script>
      const MOCK_CLASS_SCHEDULES = {
        WI24A3: {
          id: "WI24A3",
          title: "Wirtschaftsinformatik Software Engineering",
          description: "Vollständiger Semesterplan für alle Module",
          semester: "3. Semester WS 2025",
          modules: [
            {
              id: "WEB",
              name: "Webentwicklung",
              professor: "Tessa Steinigke",
              credits: 6,
              color: "blue",
            },
            {
              id: "DB",
              name: "Datenbanksysteme",
              professor: "Prof. Dr. Giacomo Welsch",
              credits: 5,
              color: "green",
            },
            {
              id: "BWL",
              name: "Betriebswirtschaftslehre",
              professor: "Prof. Dr. Mueller",
              credits: 4,
              color: "orange",
            },
            {
              id: "MATH",
              name: "Statistik",
              professor: "Prof. Dr. Markus Niedergesäss",
              credits: 5,
              color: "red",
            },
            {
              id: "IT-MGMT",
              name: "IT-Management",
              professor: "Dr. Fischer",
              credits: 4,
              color: "purple",
            },
          ],
          weeks: [
            {
              week: 1,
              startDate: "2025-10-06",
              sessions: [
                {
                  date: "2025-10-06",
                  time: "9:00-12:15",
                  module: "MATH",
                  room: "C2.02",
                },
                {
                  date: "2025-10-06",
                  time: "13:15-16:30",
                  module: "BWL",
                  room: "C2.02",
                },
                {
                  date: "2025-10-07",
                  time: "9:00-12:15",
                  module: "WEB",
                  room: "C2.02",
                },
                {
                  date: "2025-10-07",
                  time: "13:15-16:30",
                  module: "BWL",
                  room: "C2.02",
                },
                {
                  date: "2025-10-08",
                  time: "10:30-12:15",
                  module: "WEB",
                  room: "C2.02",
                },
                {
                  date: "2025-10-08",
                  time: "13:15-15:45",
                  module: "WEB",
                  room: "C2.02",
                },
                {
                  date: "2025-10-09",
                  time: "9:00-12:15",
                  module: "DB",
                  room: "Online",
                },
                {
                  date: "2025-10-09",
                  time: "12:15-16:30",
                  module: "DB",
                  room: "Online",
                },
                {
                  date: "2025-10-10",
                  time: "08:00-09:30",
                  module: "IT-MGMT",
                  room: "C2.02",
                },
              ],
            },
            {
              week: 2,
              startDate: "2025-10-13",
              sessions: [
                {
                  date: "2025-10-13",
                  time: "9:00-12:15",
                  module: "MATH",
                  room: "C2.02",
                },
                {
                  date: "2025-10-13",
                  time: "12:15-16:30",
                  module: "WEB",
                  room: "C2.02",
                },
                {
                  date: "2025-10-14",
                  time: "08:00-09:30",
                  module: "WEB",
                  room: "C2.02",
                },
                {
                  date: "2025-10-14",
                  time: "10:00-11:30",
                  module: "BWL",
                  room: "C2.02",
                },
                {
                  date: "2025-10-15",
                  time: "08:00-09:30",
                  module: "DB",
                  room: "C2.02",
                },
                {
                  date: "2025-10-15",
                  time: "10:00-11:30",
                  module: "MATH",
                  room: "C2.02",
                },
                {
                  date: "2025-10-16",
                  time: "08:00-09:30",
                  module: "WEB",
                  room: "C2.02",
                },
                {
                  date: "2025-10-17",
                  time: "08:00-09:30",
                  module: "IT-MGMT",
                  room: "C2.02",
                },
              ],
            },
            {
              week: 3,
              startDate: "2025-10-20",
              sessions: [
                {
                  date: "2025-10-20",
                  time: "9:00-12:15",
                  module: "BWL",
                  room: "C2.02",
                },
                {
                  date: "2025-10-21",
                  time: "08:00-09:30",
                  module: "WEB",
                  room: "C2.02",
                },
                {
                  date: "2025-10-21",
                  time: "10:00-11:30",
                  module: "BWL",
                  room: "C2.02",
                },
                {
                  date: "2025-10-22",
                  time: "08:00-09:30",
                  module: "DB",
                  room: "C2.02",
                },
                {
                  date: "2025-10-23",
                  time: "08:00-09:30",
                  module: "WEB",
                  room: "C2.02",
                },
                {
                  date: "2025-10-24",
                  time: "08:00-09:30",
                  module: "IT-MGMT",
                  room: "C2.02",
                },
              ],
            },
          ],
        },
        WI23A2: {
          id: "WI24A2",
          title: "Wirtschaftsinformatik 5. Semester",
          description: "Vertiefung Wirtschaftsinformatik",
          semester: "5. Semester WS 2025/25",
          modules: [
            {
              id: "ADV-DB",
              name: "Advanced Databases",
              professor: "Prof. Dr. Chen",
              credits: 6,
              color: "darkgreen",
            },
            {
              id: "ML",
              name: "Machine Learning",
              professor: "Dr. Kim",
              credits: 5,
              color: "darkblue",
            },
            {
              id: "PROJ",
              name: "Projekt",
              professor: "Prof. Dr. Wagner",
              credits: 8,
              color: "darkorange",
            },
          ],
          weeks: [
            {
              week: 1,
              startDate: "2025-10-07",
              sessions: [
                {
                  date: "2025-10-07",
                  time: "08:00-09:30",
                  module: "ADV-DB",
                  room: "A201",
                },
                {
                  date: "2025-10-08",
                  time: "10:00-11:30",
                  module: "ML",
                  room: "A202",
                },
                {
                  date: "2025-10-09",
                  time: "14:00-17:00",
                  module: "PROJ",
                  room: "Lab3",
                },
              ],
            },
          ],
        },
      };

      async function mockAPIFetch(classId) {
        /* const apiCall = await fetch(
          "https://rapla.dhbw.de/rapla/ical?key=e9U66lekDXL6sG639VTK69wZiKdfo2rPh6BxyWKXodBkdReTGOQGrZVRilYXYBV8-r4lqwlGfF18DgUBFOBwmiJyYRjQeQRkhJZkyn9AKdCuT35E6HT1mocxgwzDrjez&salt=953482152"
        );

        console.log(apicall.response);*/

        return new Promise((resolve, reject) => {
          setTimeout(() => {
            const classData = MOCK_CLASS_SCHEDULES[classId];
            if (classData) {
              resolve(classData);
            } else {
              reject(new Error(`Class ${classId} not found`));
            }
          }, 800);
        });
      }

      function formatDate(dateString) {
        const date = new Date(dateString);
        return date.toLocaleDateString("de-DE", {
          weekday: "short",
          day: "2-digit",
          month: "2-digit",
        });
      }

      function getDayName(dateString) {
        const date = new Date(dateString);
        return date.toLocaleDateString("de-DE", {
          weekday: "long",
        });
      }

      function formatDayHeader(dateString) {
        const date = new Date(dateString);
        return date.toLocaleDateString("de-DE", {
          weekday: "long",
          day: "2-digit",
          month: "2-digit",
        });
      }

      function getModuleColor(modules, moduleId) {
        const module = modules.find((m) => m.id === moduleId);
        return module ? module.color : "gray";
      }

      function getModuleName(modules, moduleId) {
        const module = modules.find((m) => m.id === moduleId);
        return module ? module.name : moduleId;
      }

      function isDateInPast(dateString) {
        const sessionDate = new Date(dateString);
        const today = new Date();

        // Set both dates to start of day for accurate comparison
        sessionDate.setHours(0, 0, 0, 0);
        today.setHours(0, 0, 0, 0);

        return sessionDate < today;
      }

      function isToday(dateString) {
        const sessionDate = new Date(dateString);
        const targetDate = getScrollTargetDate();

        sessionDate.setHours(0, 0, 0, 0);
        targetDate.setHours(0, 0, 0, 0);

        return sessionDate.getTime() === targetDate.getTime();
      }

      function getScrollTargetDate() {
        const today = new Date();
        const dayOfWeek = today.getDay();

        if (dayOfWeek === 0 || dayOfWeek === 6) {
          const daysUntilMonday = dayOfWeek === 0 ? 1 : 2;
          const nextMonday = new Date(today);
          nextMonday.setDate(today.getDate() + daysUntilMonday);
          return nextMonday;
        }

        return today;
      }

      function formatRoom(room) {
        if (room === "Online") {
          return `<mark>${room}</mark>`;
        }
        return room;
      }

      function isWeekInPast(weekStartDate) {
        const startDate = new Date(weekStartDate);
        const endDate = new Date(startDate);
        endDate.setDate(startDate.getDate() + 6);
        const today = new Date();

        startDate.setHours(0, 0, 0, 0);
        endDate.setHours(23, 59, 59, 999);
        today.setHours(0, 0, 0, 0);

        return endDate < today;
      }

      function scrollToCurrentDay() {
        const currentDayElement = document.getElementById("current-day");
        if (currentDayElement) {
          currentDayElement.scrollIntoView({
            behavior: "smooth",
            block: "center",
          });
        }
      }

      function renderModules(modules) {
        const container = document.getElementById("modules-container");
        container.innerHTML = "";

        modules.forEach((module) => {
          const moduleDiv = document.createElement("div");
          moduleDiv.className = "module-card";
          moduleDiv.style.borderLeftColor = module.color;

          moduleDiv.innerHTML = `
            <div class="module-name">${module.name}</div>
            <div class="module-details">${module.professor}</div>
            <div class="module-credits">${module.credits} ECTS</div>
          `;

          container.appendChild(moduleDiv);
        });
      }

      // Function to get calendar week number
      function getCalendarWeek(dateString) {
        const date = new Date(dateString);
        const firstDayOfYear = new Date(date.getFullYear(), 0, 1);
        const dayNumber = Math.floor(
          (date - firstDayOfYear) / (24 * 60 * 60 * 1000)
        );
        const weekNumber = Math.ceil(
          (dayNumber + firstDayOfYear.getDay() + 1) / 7
        );
        return weekNumber;
      }

      function renderClassWeeks(weeks, modules) {
        const container = document.getElementById("weeks-container");
        container.innerHTML = "";

        const pastWeeks = weeks.filter((week) => isWeekInPast(week.startDate));
        const futureWeeks = weeks.filter(
          (week) => !isWeekInPast(week.startDate)
        );

        if (pastWeeks.length > 0) {
          const pastWeeksSection = document.createElement("div");
          pastWeeksSection.className = "accordion-section past-weeks-section";

          const pastWeeksHeader = document.createElement("div");
          pastWeeksHeader.className = "accordion-header collapsed";
          pastWeeksHeader.setAttribute("data-target", "past-weeks-content");

          const pastWeeksTitle = document.createElement("h4");
          pastWeeksTitle.textContent = `Vergangene Wochen (${pastWeeks.length})`;

          const toggle = document.createElement("span");
          toggle.className = "accordion-toggle";
          toggle.innerHTML = `
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" d="m19.5 8.25-7.5 7.5-7.5-7.5" />
            </svg>
          `;

          pastWeeksHeader.appendChild(pastWeeksTitle);
          pastWeeksHeader.appendChild(toggle);
          pastWeeksSection.appendChild(pastWeeksHeader);

          const pastWeeksContent = document.createElement("div");
          pastWeeksContent.id = "past-weeks-content";
          pastWeeksContent.className = "accordion-content collapsed";

          pastWeeks.forEach((week) => {
            const weekDiv = renderWeekContent(week, modules);
            pastWeeksContent.appendChild(weekDiv);
          });

          pastWeeksSection.appendChild(pastWeeksContent);
          container.appendChild(pastWeeksSection);
        }

        futureWeeks.forEach((week) => {
          const weekDiv = renderWeekContent(week, modules);
          container.appendChild(weekDiv);
        });
      }

      function renderWeekContent(week, modules) {
        const weekDiv = document.createElement("div");
        weekDiv.className = "week-timeline";

        const weekHeader = document.createElement("h4");
        weekHeader.textContent = `KW ${getCalendarWeek(week.startDate)}`;
        weekDiv.appendChild(weekHeader);

        const sessionsContainer = document.createElement("div");
        sessionsContainer.className = "sessions-container";

        const dayGroups = week.sessions.reduce((groups, session) => {
          const dayName = getDayName(session.date);
          if (!groups[dayName]) groups[dayName] = [];
          groups[dayName].push(session);
          return groups;
        }, {});

        Object.entries(dayGroups).forEach(([day, sessions]) => {
          const dayDiv = document.createElement("div");
          dayDiv.className = "day-group";

          if (isToday(sessions[0].date)) {
            dayDiv.id = "current-day";
          }

          const dayHeader = document.createElement("h5");
          dayHeader.textContent = formatDayHeader(sessions[0].date);
          dayDiv.appendChild(dayHeader);

          sessions.forEach((session) => {
            const sessionDiv = document.createElement("div");
            sessionDiv.className = `session-item`;

            if (isDateInPast(session.date)) {
              sessionDiv.classList.add("past-session");
            }

            sessionDiv.style.borderLeftColor = getModuleColor(
              modules,
              session.module
            );

            sessionDiv.innerHTML = `
              <div class="session-time">${session.time}</div>
              <div class="session-module">${getModuleName(
                modules,
                session.module
              )}</div>
              <div class="session-room">${formatRoom(session.room)}</div>
            `;

            dayDiv.appendChild(sessionDiv);
          });

          sessionsContainer.appendChild(dayDiv);
        });

        weekDiv.appendChild(sessionsContainer);
        return weekDiv;
      }

      function showLoadingState() {
        document.getElementById("loading-state").classList.remove("hidden");
        document.getElementById("error-state").classList.add("hidden");
        document.getElementById("plan-content").classList.add("hidden");
      }

      function showErrorState() {
        document.getElementById("loading-state").classList.add("hidden");
        document.getElementById("error-state").classList.remove("hidden");
        document.getElementById("plan-content").classList.add("hidden");
      }

      function initializeAccordions() {
        const accordionHeaders = document.querySelectorAll(".accordion-header");

        accordionHeaders.forEach((header) => {
          header.addEventListener("click", function () {
            const targetId = this.getAttribute("data-target");
            const content = document.getElementById(targetId);
            const toggle = this.querySelector(".accordion-toggle");

            if (this.classList.contains("collapsed")) {
              this.classList.remove("collapsed");
              this.classList.add("expanded");
              content.classList.remove("collapsed");
              content.classList.add("expanded");
              toggle.innerHTML =
                '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m4.5 15.75 7.5-7.5 7.5 7.5" /></svg>';
            } else {
              this.classList.remove("expanded");
              this.classList.add("collapsed");
              content.classList.remove("expanded");
              content.classList.add("collapsed");
              toggle.innerHTML =
                '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m19.5 8.25-7.5 7.5-7.5-7.5" /></svg>';
            }
          });
        });
      }

      function showPlanContent(classData) {
        document.getElementById("loading-state").classList.add("hidden");
        document.getElementById("error-state").classList.add("hidden");
        document.getElementById("plan-content").classList.remove("hidden");

        document.getElementById("class-title").textContent = classData.title;
        document.getElementById("class-description").textContent =
          classData.description;
        document.getElementById("class-semester").textContent =
          classData.semester;

        renderModules(classData.modules);
        renderClassWeeks(classData.weeks, classData.modules);
        initializeAccordions();

        setTimeout(() => {
          scrollToCurrentDay();
        }, 100);
      }

      function storeClassInLocalStorage(classData) {
        localStorage.setItem("selectedClass", JSON.stringify(classData));
        localStorage.setItem("lastViewedClass", classData.id);
      }

      async function loadClassPlan(classId) {
        if (!classId) return;

        showLoadingState();

        try {
          const classData = await mockAPIFetch(classId);
          showPlanContent(classData);
          storeClassInLocalStorage(classData);
        } catch (error) {
          console.error("Failed to load class:", error);
          showErrorState();
        }
      }

      const params = new URLSearchParams(document.location.search);
      const classParam = params.get("class") || params.get("course");
      const classIDEl = document.getElementById("class-id");

      if (classParam) {
        classIDEl.textContent = classParam;
        loadClassPlan(classParam);
      } else {
        classIDEl.textContent = "Bitte wählen Sie einen Kurs";
        showErrorState();
      }
    </script>
  </body>
</html>
